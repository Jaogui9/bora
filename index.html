<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bora - Eventos em Piracicaba</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bora">
    
    <!-- Preload Critical Resources -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(45deg, #FF6B35, #F7931E);
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --border-radius: 15px;
            --shadow-light: 0 5px 15px rgba(0,0,0,0.1);
            --shadow-heavy: 0 20px 60px rgba(0,0,0,0.3);
            --transition-fast: 0.2s ease;
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa; 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 20px) env(safe-area-inset-bottom, 20px) env(safe-area-inset-left, 20px);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .phone-container { width: min(375px, 100vw); height: min(667px, 100vh); background: #000; border-radius: 30px; padding: 4px; box-shadow: var(--shadow-heavy); position: relative; overflow: hidden; transform: translateZ(0); }
        .screen { width: 100%; height: 100%; background: #ffffff; border-radius: 26px; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .status-bar { background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: max(env(safe-area-inset-top), 8px) 20px 8px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 600; flex-shrink: 0; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .main-content { flex: 1; position: relative; overflow: hidden; }
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; background: #ffffff; opacity: 0; transform: translateX(20px); transition: all var(--transition-smooth); }
        .page.active { display: flex; opacity: 1; transform: translateX(0); }
        .header { background: var(--primary-gradient); color: white; padding: 25px 20px 20px 20px; text-align: center; flex-shrink: 0; position: relative; overflow: hidden; }
        .logo { font-size: 36px; font-weight: 800; position: relative; z-index: 2; cursor: pointer; transition: transform var(--transition-fast); text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .subtitle { font-size: 15px; opacity: 0.95; font-weight: 500; margin-top: 5px; position: relative; z-index: 2; }
        .location { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px; font-size: 13px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; position: relative; z-index: 2; display: inline-flex; }
        .content { flex: 1; overflow-y: auto; padding: 20px 15px; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; }
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
        .filter-tabs::-webkit-scrollbar { display: none; }
        .tab { background: #f8f9fa; border: 2px solid transparent; padding: 12px 20px; border-radius: 25px; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all var(--transition-smooth); position: relative; overflow: hidden; }
        .tab.active { background: var(--primary-gradient); color: white; border-color: rgba(255,255,255,0.3); transform: translateY(-2px); box-shadow: var(--shadow-light); }
        .event-card { background: white; border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--shadow-light); overflow: hidden; position: relative; transition: all var(--transition-smooth); border: 1px solid rgba(0,0,0,0.05); }
        .event-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        .event-image { width: 100%; height: 140px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: 800; position: relative; background: var(--secondary-gradient); overflow: hidden; background-size: cover; background-position: center; }
        .event-info { padding: 20px; }
        .event-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; color: #1a1a1a; line-height: 1.4; }
        .event-date { color: #667eea; font-size: 13px; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .event-location { color: #666; font-size: 13px; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .event-description { font-size: 14px; color: #555; line-height: 1.5; margin-top: 10px; border-left: 3px solid #667eea; padding-left: 10px; }
        .event-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .attendee-count { font-size: 14px; font-weight: 600; color: #333; }
        .confirm-btn { background: var(--primary-gradient); color: white; border: none; padding: 10px 18px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); }
        .confirm-btn.attending { background: var(--success-color); }
        .premium-badge { position: absolute; top: 12px; right: 12px; background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; padding: 6px 12px; border-radius: 15px; font-size: 10px; font-weight: 800; z-index: 3; box-shadow: 0 4px 15px rgba(255,215,0,0.4); }
        .bottom-nav { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 12px 0 max(env(safe-area-inset-bottom), 12px) 0; flex-shrink: 0; }
        .nav-item { text-align: center; cursor: pointer; padding: 8px 12px; border-radius: 12px; transition: all var(--transition-smooth); position: relative; min-width: 60px; }
        .nav-item.active { background: rgba(102, 126, 234, 0.1); color: #667eea; transform: translateY(-2px); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; transition: transform var(--transition-fast); }
        .nav-label { font-size: 11px; font-weight: 600; }
        .placeholder-text { text-align: center; margin-top: 60px; color: #999; font-size: 15px; padding: 0 30px; line-height: 1.6; }
        .fab { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); right: 20px; width: 64px; height: 64px; background: var(--primary-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; font-weight: 300; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); cursor: pointer; transition: all var(--transition-smooth); z-index: 1000; border: 3px solid rgba(255,255,255,0.2); }
        .fab:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6); }
        .fab.hidden { transform: scale(0); opacity: 0; pointer-events: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 2000; padding: env(safe-area-inset-top, 20px) env(safe-area-inset-right, 20px) env(safe-area-inset-bottom, 20px) env(safe-area-inset-left, 20px); opacity: 0; transition: opacity var(--transition-smooth); }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal { background: white; border-radius: 25px; width: 100%; max-width: 420px; max-height: min(85vh, 600px); overflow: hidden; box-shadow: var(--shadow-heavy); position: relative; transform: scale(0.8) translateY(50px); transition: all var(--transition-smooth); }
        .modal-overlay.show .modal { transform: scale(1) translateY(0); }
        .modal-header { background: var(--primary-gradient); color: white; padding: 25px 20px 20px 20px; position: relative; overflow: hidden; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; cursor: pointer; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 6px; position: relative; z-index: 2; }
        .modal-subtitle { opacity: 0.95; font-size: 15px; position: relative; z-index: 2; }
        .modal-content { padding: 25px 20px; max-height: min(60vh, 500px); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .form-group { margin-bottom: 24px; position: relative; }
        .form-label { display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 14px; }
        .form-input { width: 100%; padding: 16px; border: 2px solid #e8ecf4; border-radius: 12px; font-size: 16px; transition: all var(--transition-smooth); background: #fafbfc; font-family: inherit; }
        .form-input:focus { outline: none; border-color: #667eea; background: white; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); transform: translateY(-1px); }
        .submit-btn { width: 100%; padding: 18px; background: var(--primary-gradient); color: white; border: none; border-radius: 16px; font-size: 17px; font-weight: 700; cursor: pointer; transition: all var(--transition-smooth); position: relative; overflow: hidden; margin-top: 10px; }
        .submit-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
        .submit-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none !important; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #ffffff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .profile-container { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 20px; }
        .profile-pic { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 15px; border: 4px solid white; box-shadow: var(--shadow-light); }
        .profile-name { font-size: 22px; font-weight: 700; color: #333; }
        .profile-email { font-size: 14px; color: #666; margin-bottom: 25px; }
        .google-btn { display: inline-flex; align-items: center; justify-content: center; gap: 15px; background-color: #fff; color: #444; border-radius: 8px; border: 1px solid #ddd; padding: 12px 24px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); box-shadow: var(--shadow-light); }
        .google-btn:hover { background-color: #f8f8f8; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .google-btn img { width: 24px; height: 24px; }
        .logout-btn { background: var(--danger-color); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); }
        .logout-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .gemini-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #764ba2; transition: transform 0.2s; }
        .gemini-btn:hover { transform: translateY(-50%) scale(1.2); }
        .gemini-btn.loading { animation: spin 1s linear infinite; }
        .gemini-suggest-btn { background: var(--primary-gradient); color: white; border: none; padding: 14px 24px; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); box-shadow: var(--shadow-light); display: block; margin: 20px auto 0 auto; }
        .gemini-suggest-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .section-title { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .pricing-options { display: flex; flex-direction: column; gap: 12px; }
        .pricing-option { border: 2px solid #e8ecf4; border-radius: 16px; padding: 15px; cursor: pointer; transition: all var(--transition-smooth); position: relative; }
        .pricing-option.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05)); }
        .pricing-title { font-weight: 700; font-size: 16px; color: #1a1a1a; }
        .pricing-description { font-size: 13px; color: #666; }
        .pricing-price { font-size: 18px; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="screen">
            <div class="status-bar"><span>9:41</span><span>üì∂ üîã</span></div>
            <div class="main-content">
                <!-- P√ÅGINA IN√çCIO -->
                <div id="page-inicio" class="page active">
                    <div class="header">
                        <div class="logo">Bora</div>
                        <div class="subtitle">Encontre os melhores eventos</div>
                        <div class="location">üìç Piracicaba, SP</div>
                    </div>
                    <div class="content">
                        <div class="filter-tabs">
                            <div class="tab active" onclick="filterEvents('todos', event)"><span>Todos</span></div>
                            <div class="tab" onclick="filterEvents('festas', event)"><span>Festas</span></div>
                            <div class="tab" onclick="filterEvents('shows', event)"><span>Shows</span></div>
                            <div class="tab" onclick="filterEvents('rodeios', event)"><span>Rodeios</span></div>
                        </div>
                        <div id="event-list">
                            <p class="placeholder-text">Carregando eventos...</p>
                        </div>
                    </div>
                </div>
                
                <!-- P√ÅGINA MEUS EVENTOS -->
                <div id="page-meus-eventos" class="page">
                    <div class="header">
                        <div class="logo">Meus Eventos</div>
                        <div class="subtitle">Sua atividade na plataforma</div>
                    </div>
                    <div class="content">
                        <div class="section-title">üéâ Eventos que voc√™ confirmou</div>
                        <div id="attending-events-list">
                            <!-- Conte√∫do din√¢mico aqui -->
                        </div>
                        <div class="section-title" style="margin-top: 30px;">‚úçÔ∏è Eventos que voc√™ criou</div>
                        <div id="my-created-events-list">
                            <!-- Conte√∫do din√¢mico aqui -->
                        </div>
                    </div>
                </div>
                
                <!-- P√ÅGINA PR√ìXIMOS -->
                <div id="page-proximos" class="page">
                    <div class="header">
                        <div class="logo">Eventos Pr√≥ximos</div>
                        <div class="subtitle">Baseado na sua localiza√ß√£o</div>
                    </div>
                    <div class="content">
                         <p class="placeholder-text">Em breve, voc√™ poder√° ver eventos perto de voc√™! üó∫Ô∏è</p>
                    </div>
                </div>
                
                <!-- P√ÅGINA PERFIL -->
                <div id="page-perfil" class="page">
                    <div class="header">
                        <div class="logo">Meu Perfil</div>
                        <div class="subtitle">Sua conta e configura√ß√µes</div>
                    </div>
                    <div class="content" id="profile-content">
                        <!-- Conte√∫do din√¢mico de login/perfil -->
                    </div>
                </div>
            </div>
            
            <div class="bottom-nav">
                <div class="nav-item active" onclick="showPage('inicio')"> <div class="nav-icon">üè†</div> <div class="nav-label">In√≠cio</div> </div>
                <div class="nav-item" onclick="showPage('meus-eventos')"> <div class="nav-icon">üìÖ</div> <div class="nav-label">Meus Eventos</div> </div>
                <div class="nav-item" onclick="showPage('proximos')"> <div class="nav-icon">üìç</div> <div class="nav-label">Pr√≥ximos</div> </div>
                <div class="nav-item" onclick="showPage('perfil')"> <div class="nav-icon">üë§</div> <div class="nav-label">Perfil</div> </div>
            </div>
        </div>
    </div>
    
    <!-- Bot√£o Flutuante (FAB) -->
    <div class="fab" id="fab" onclick="openModal()">+</div>
    
    <!-- Modal Criar Evento -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()">&times;</button>
                <div class="modal-title">Criar Evento</div>
                <div class="modal-subtitle">Divulgue seu evento em Piracicaba</div>
            </div>
            <div class="modal-content">
                <form id="eventForm" novalidate>
                    <div class="form-group">
                        <label class="form-label" for="eventName">Nome do Evento *</label>
                        <input type="text" class="form-input" id="eventName" placeholder="Ex: Festa da Faculdade" required>
                        <button type="button" class="gemini-btn" id="generateDescBtn" onclick="generateDescription()">‚ú®</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="eventDescription">Descri√ß√£o do Evento</label>
                        <textarea class="form-input" id="eventDescription" placeholder="Descreva seu evento ou use a IA ‚ú®" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="eventDate">Data e Hora *</label>
                        <input type="datetime-local" class="form-input" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="eventLocation">Local *</label>
                        <input type="text" class="form-input" id="eventLocation" placeholder="Endere√ßo completo" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select class="form-input" id="eventCategory" required>
                            <option value="festas">üéâ Festas</option>
                            <option value="shows">üéµ Shows</option>
                            <option value="rodeios">ü§† Rodeios</option>
                            <option value="cultura">üé® Cultura</option>
                        </select>
                    </div>

                    <!-- Novos Planos de Pre√ßo -->
                    <div class="form-group">
                        <label class="form-label">Escolha o plano de divulga√ß√£o:</label>
                        <div class="pricing-options">
                            <div class="pricing-option selected" onclick="selectPlan('gratuito', 0, this)">
                                <div class="pricing-title">üÜì Gratuito</div>
                                <div class="pricing-description">Alcance at√© 100 pessoas</div>
                                <div class="pricing-price">R$ 0</div>
                            </div>
                            <div class="pricing-option" onclick="selectPlan('m√©dio', 50, this)">
                                <div class="pricing-title">‚≠ê M√©dio</div>
                                <div class="pricing-description">Alcance at√© 500 pessoas</div>
                                <div class="pricing-price">R$ 50</div>
                            </div>
                            <div class="pricing-option" onclick="selectPlan('premium', 100, this)">
                                <div class="pricing-title">üöÄ Premium</div>
                                <div class="pricing-description">Alcance at√© 1000 pessoas</div>
                                <div class="pricing-price">R$ 100</div>
                            </div>
                            <div class="pricing-option" onclick="selectPlan('ilimitado', 200, this)">
                                <div class="pricing-title">ÔøΩ Ilimitado</div>
                                <div class="pricing-description">Alcance ilimitado</div>
                                <div class="pricing-price">R$ 200</div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="submitBtn">
                        <span id="btn-text">Publicar Evento (Gr√°tis)</span>
                        <span id="btn-loading" class="loading" style="display: none;"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 4000; display: flex; flex-direction: column; gap: 10px;"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDsCKb-e9GHtBTdKwEmRoSTGCQOJjFZfEg",
            authDomain: "meu-app-eventos.firebaseapp.com",
            projectId: "meu-app-eventos",
            storageBucket: "meu-app-eventos.firebasestorage.app",
            messagingSenderId: "611882575960",
            appId: "1:611882575960:web:b39bd5a45f4d4d63c2022d",
            measurementId: "G-2Y4YQ003HC"
        };

        // ===== INICIALIZA√á√ÉO FIREBASE =====
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const eventsCollection = db.collection('events');

        // ===== VARI√ÅVEIS GLOBAIS =====
        let currentUser = null;
        let selectedPlan = { name: 'gratuito', price: 0 };

        // ===== INICIALIZA√á√ÉO DO APP =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            const now = new Date();
            const minDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('eventDate').min = minDate;
            console.log('üöÄ Bora App initialized with Firebase and Gemini!');
        }

        // ===== LISTENERS DE EVENTOS =====
        function setupEventListeners() {
            document.getElementById('eventForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('modalOverlay').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });
        }

        // ===== AUTENTICA√á√ÉO =====
        auth.onAuthStateChanged(user => {
            currentUser = user;
            updateUIForAuthState();
            if (user) {
                loadAllEvents();
                loadMyEvents();
                loadAttendingEvents();
            } else {
                document.getElementById('event-list').innerHTML = '<p class="placeholder-text">Fa√ßa login para ver os eventos.</p>';
                document.getElementById('my-created-events-list').innerHTML = '<p class="placeholder-text">Fa√ßa login para ver seus eventos.</p>';
                document.getElementById('attending-events-list').innerHTML = '<p class="placeholder-text">Fa√ßa login para ver seus eventos.</p>';
            }
        });

        function updateUIForAuthState() {
            const profileContent = document.getElementById('profile-content');
            const fab = document.getElementById('fab');

            if (currentUser) {
                profileContent.innerHTML = `
                    <div class="profile-container">
                        <img src="${currentUser.photoURL}" alt="Foto do Perfil" class="profile-pic">
                        <div class="profile-name">${currentUser.displayName}</div>
                        <div class="profile-email">${currentUser.email}</div>
                        <button class="logout-btn" onclick="signOut()">Sair</button>
                    </div>
                `;
                fab.classList.remove('hidden');
            } else {
                profileContent.innerHTML = `
                    <div class="profile-container">
                        <p class="placeholder-text" style="margin-bottom: 20px;">Fa√ßa login para criar eventos e ver seu perfil.</p>
                        <button class="google-btn" onclick="signInWithGoogle()">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google logo">
                            <span>Entrar com Google</span>
                        </button>
                    </div>
                `;
                fab.classList.add('hidden');
            }
        }

        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    showToast(`Bem-vindo, ${result.user.displayName}!`, 'success');
                })
                .catch(error => {
                    console.error("Erro no login com Google:", error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        showToast('Login cancelado.', 'info');
                    } else if (error.code === 'auth/popup-blocked') {
                        showToast('Pop-up bloqueado pelo navegador. Por favor, permita os pop-ups para este site.', 'warning');
                    } else {
                        showToast('Ocorreu um erro durante o login.', 'error');
                    }
                });
        }

        function signOut() {
            auth.signOut()
                .then(() => {
                    showToast('Voc√™ saiu da sua conta.', 'info');
                })
                .catch(error => {
                    console.error("Erro ao sair:", error);
                    showToast('Erro ao sair da conta.', 'error');
                });
        }

        // ===== NAVEGA√á√ÉO E FILTRO =====
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            
            if (pageId === 'meus-eventos' && !currentUser) {
                showToast('Fa√ßa login para aceder aos seus eventos.', 'warning');
                showPage('perfil');
                return;
            }

            document.getElementById(`page-${pageId}`).classList.add('active');
            document.querySelector(`.nav-item[onclick="showPage('${pageId}')"]`).classList.add('active');
        }

        function filterEvents(category, event) {
            document.querySelectorAll('.filter-tabs .tab').forEach(tab => tab.classList.remove('active'));
            if (event) {
                event.currentTarget.classList.add('active');
            }

            const eventCards = document.querySelectorAll('#event-list .event-card');
            eventCards.forEach(card => {
                const cardCategory = card.dataset.category;
                if (category === 'todos' || cardCategory === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // ===== GEST√ÉO DE EVENTOS (FIRESTORE) =====
        function loadAllEvents() {
            const eventList = document.getElementById('event-list');
            eventsCollection.orderBy('date', 'asc').onSnapshot(snapshot => {
                if (snapshot.empty) {
                    eventList.innerHTML = `
                        <div class="placeholder-text">
                            Nenhum evento por aqui ainda... Que tal uma inspira√ß√£o?
                            <button class="gemini-suggest-btn" onclick="suggestEvents()">‚ú® Sugerir eventos para mim</button>
                        </div>
                    `;
                    return;
                }
                eventList.innerHTML = '';
                snapshot.forEach(doc => renderEventCard(doc, eventList));
            }, err => {
                console.error("Erro ao carregar eventos:", err);
                showToast('Erro ao carregar eventos.', 'error');
            });
        }

        function loadMyEvents() {
            if (!currentUser) return;
            const myEventList = document.getElementById('my-created-events-list');
            eventsCollection.where('creatorId', '==', currentUser.uid).orderBy('date', 'asc').onSnapshot(snapshot => {
                if (snapshot.empty) {
                    myEventList.innerHTML = '<p class="placeholder-text">Voc√™ ainda n√£o criou nenhum evento.</p>';
                    return;
                }
                myEventList.innerHTML = '';
                snapshot.forEach(doc => renderEventCard(doc, myEventList));
            }, err => {
                console.error("Erro ao carregar os meus eventos criados:", err);
            });
        }

        function loadAttendingEvents() {
            if (!currentUser) return;
            const attendingEventList = document.getElementById('attending-events-list');
            eventsCollection.where('attendees', 'array-contains', currentUser.uid).orderBy('date', 'asc').onSnapshot(snapshot => {
                if (snapshot.empty) {
                    attendingEventList.innerHTML = '<p class="placeholder-text">Voc√™ ainda n√£o confirmou presen√ßa em nenhum evento.</p>';
                    return;
                }
                attendingEventList.innerHTML = '';
                snapshot.forEach(doc => renderEventCard(doc, attendingEventList));
            }, err => {
                console.error("Erro ao carregar eventos confirmados:", err);
            });
        }

        function renderEventCard(doc, container, isSuggestion = false) {
            const data = doc.data();
            const id = doc.id;
            const eventDate = data.date ? new Date(data.date).toLocaleString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Data a definir';
            const imageStyle = `background: var(--secondary-gradient);`;

            const attendees = data.attendees || [];
            const isAttending = currentUser ? attendees.includes(currentUser.uid) : false;
            const plan = data.plan || { name: 'gratuito', price: 0 };

            const cardHTML = `
                <div class="event-card" data-category="${data.category}" data-id="${id}" style="${isSuggestion ? 'opacity: 0.7; border-style: dashed;' : ''}">
                    ${plan.price > 0 ? `<div class="premium-badge">DESTAQUE</div>` : ''}
                    <div class="event-image" style="${imageStyle}">
                        ${data.category.toUpperCase()}
                    </div>
                    <div class="event-info">
                        <div class="event-title">${data.name}</div>
                        <div class="event-date">üìÖ ${eventDate}</div>
                        <div class="event-location">üìç ${data.location}</div>
                        ${data.description ? `<p class="event-description">${data.description}</p>` : ''}
                        <div class="event-actions">
                            <div class="attendee-count">üë• ${attendees.length} v√£o</div>
                            <button class="confirm-btn ${isAttending ? 'attending' : ''}" onclick="toggleAttendance('${id}')">
                                ${isAttending ? '‚úîÔ∏è Confirmado' : 'Confirmar Presen√ßa'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHTML);
        }

        async function toggleAttendance(eventId) {
            if (!currentUser) {
                showToast('Fa√ßa login para confirmar presen√ßa.', 'warning');
                return;
            }

            const eventRef = eventsCollection.doc(eventId);
            try {
                const eventDoc = await eventRef.get();
                if (!eventDoc.exists) {
                    showToast('Evento n√£o encontrado.', 'error');
                    return;
                }

                const attendees = eventDoc.data().attendees || [];
                const isAttending = attendees.includes(currentUser.uid);

                if (isAttending) {
                    await eventRef.update({
                        attendees: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                    });
                    showToast('Presen√ßa removida.', 'info');
                } else {
                    await eventRef.update({
                        attendees: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                    showToast('Presen√ßa confirmada! üéâ', 'success');
                }
            } catch (error) {
                console.error("Erro ao confirmar presen√ßa:", error);
                showToast("Ocorreu um erro. Tente novamente.", "error");
            }
        }

        // ===== FORMUL√ÅRIO =====
        function selectPlan(planName, price, element) {
            selectedPlan = { name: planName, price: price };
            
            document.querySelectorAll('.pricing-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');

            const btnText = document.getElementById('btn-text');
            if (price === 0) {
                btnText.textContent = 'Publicar Evento (Gr√°tis)';
            } else {
                btnText.textContent = `Publicar Evento (R$ ${price})`;
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!currentUser) {
                showToast('Voc√™ precisa de estar logado para criar um evento.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btn-text');
            const btnLoading = document.getElementById('btn-loading');
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';

            try {
                const eventData = {
                    name: document.getElementById('eventName').value,
                    description: document.getElementById('eventDescription').value,
                    date: document.getElementById('eventDate').value,
                    location: document.getElementById('eventLocation').value,
                    category: document.getElementById('eventCategory').value,
                    creatorId: currentUser.uid,
                    creatorName: currentUser.displayName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    attendees: [],
                    plan: selectedPlan // Salva o plano escolhido
                };
                await eventsCollection.add(eventData);
                
                showToast('üéâ Evento criado com sucesso!', 'success');
                closeModal();

            } catch (error) {
                console.error("Erro ao criar evento:", error);
                showToast('Erro ao criar evento. Tente novamente.', 'error');
            } finally {
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
            }
        }

        // ===== FUNCIONALIDADES COM A API GEMINI =====
        async function callGeminiAPI(prompt, isJson = false) {
            const apiKey = ""; // Deixe em branco, ser√° fornecido pelo ambiente
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            if (isJson) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "eventName": { "type": "STRING" },
                                "category": { "type": "STRING", "enum": ["festas", "shows", "rodeios", "cultura"] },
                                "location": { "type": "STRING" }
                            },
                            required: ["eventName", "category", "location"]
                        }
                    }
                };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return text;
                } else {
                    throw new Error("Resposta da API inv√°lida.");
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                showToast("Erro ao contatar a IA. Tente novamente.", "error");
                return null;
            }
        }

        async function generateDescription() {
            const eventName = document.getElementById('eventName').value;
            const eventLocation = document.getElementById('eventLocation').value;
            const eventDate = document.getElementById('eventDate').value;
            const generateBtn = document.getElementById('generateDescBtn');

            if (!eventName) {
                showToast("Por favor, preencha o nome do evento primeiro.", "warning");
                return;
            }

            generateBtn.classList.add('loading');
            generateBtn.disabled = true;

            const prompt = `Crie uma descri√ß√£o curta, animada e convidativa (m√°ximo 2-3 frases) para o seguinte evento:
            - Nome: ${eventName}
            - Local: ${eventLocation}
            - Data: ${new Date(eventDate).toLocaleDateString('pt-BR', {weekday: 'long', day: '2-digit', month: 'long'})}
            A descri√ß√£o deve ser em portugu√™s do Brasil.`;
            
            const description = await callGeminiAPI(prompt);

            if (description) {
                document.getElementById('eventDescription').value = description.trim();
                showToast("Descri√ß√£o gerada com sucesso!", "success");
            }

            generateBtn.classList.remove('loading');
            generateBtn.disabled = false;
        }

        async function suggestEvents() {
            const eventList = document.getElementById('event-list');
            eventList.innerHTML = '<p class="placeholder-text">‚ú® A IA est√° a pensar nas melhores ideias para si...</p>';

            const prompt = `Sugira 3 ideias criativas de eventos para a cidade de Piracicaba, SP, Brasil. Considere a cultura local. Retorne apenas um JSON v√°lido, sem markdown, seguindo o schema. As categorias devem ser uma de: "festas", "shows", "rodeios", "cultura".`;
            
            const result = await callGeminiAPI(prompt, true);

            if (result) {
                try {
                    const suggestions = JSON.parse(result);
                    eventList.innerHTML = ''; // Limpa a mensagem de "pensando"
                    suggestions.forEach((event, index) => {
                        const fakeDoc = {
                            id: `suggestion-${index}`,
                            data: () => ({
                                name: event.eventName,
                                category: event.category,
                                location: event.location,
                                description: "Esta √© uma sugest√£o da IA. Que tal torn√°-la realidade?",
                                attendees: []
                            })
                        };
                        renderEventCard(fakeDoc, eventList, true);
                    });
                } catch (e) {
                    console.error("Erro ao analisar JSON da IA:", e);
                    showToast("A IA retornou uma sugest√£o inv√°lida. Tente novamente.", "error");
                    eventList.innerHTML = '<p class="placeholder-text">Ocorreu um erro. Tente novamente.</p>';
                }
            } else {
                 eventList.innerHTML = '<p class="placeholder-text">N√£o foi poss√≠vel gerar sugest√µes. Tente novamente mais tarde.</p>';
            }
        }

        // ===== MODAL =====
        function openModal() {
            if (!currentUser) {
                showToast('Fa√ßa login para criar um evento.', 'warning');
                showPage('perfil');
                return;
            }
            document.getElementById('modalOverlay').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            document.getElementById('eventForm').reset();
            // Resetar o plano para o padr√£o
            selectPlan('gratuito', 0, document.querySelector('.pricing-option'));
        }

        // ===== FUN√á√ïES UTILIT√ÅRIAS =====
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = { success: '#28a745', error: '#dc3545', warning: '#ffc107', info: '#667eea' };
            toast.style.cssText = `background: ${colors[type]}; color: white; padding: 16px 20px; border-radius: 12px; box-shadow: var(--shadow-heavy); font-weight: 600; font-size: 14px; max-width: 320px; transform: translateX(120%); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);`;
            toast.textContent = message;
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 100);
            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
                setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
            }, 3500);
        }
    </script>
</body>
</html>
